<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Golf Coach - Wright Now Solutions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN production warning for development
        const originalWarn = console.warn;
        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('cdn.tailwindcss.com should not be used in production')) {
                return; // Suppress this specific warning
            }
            originalWarn.apply(console, args); // Allow other warnings
        };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .app-bg {
            background-image: url('https://images.unsplash.com/photo-1535131749006-b7f58c99034b?q=80&w=2070&auto=format&fit=crop');
        }
        .screen {
            display: none !important;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 1rem;
            animation: fadeIn 0.5s ease-in-out;
        }
        .screen.active {
            display: flex !important;
            flex-direction: column !important;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .speaking-indicator {
            background: linear-gradient(90deg, #10b981, #06b6d4);
            animation: gradient 3s ease infinite;
            background-size: 200% 100%;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="app-bg bg-cover bg-center h-screen flex items-center justify-center p-4">

    <!-- Mobile Phone Frame -->
    <div class="w-full max-w-md h-[90vh] max-h-[800px] bg-gray-900/80 backdrop-blur-xl rounded-[40px] shadow-2xl p-4 flex flex-col overflow-hidden ring-4 ring-gray-600/50 relative">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen active flex-1 flex flex-col">
            <div class="flex-1 flex flex-col items-center justify-center p-6">
                <img src="Wright-Now-Solutions-Web-Logo-min.png" alt="Wright Now Solutions" class="w-32 mb-6">
                <h1 class="text-3xl font-bold text-white mb-2">AI Golf Coach</h1>
                <p class="text-gray-300 text-center mb-8">Get personalized golf advice powered by AI</p>
                
                <div class="w-full space-y-4">
                    <input type="text" id="user-name" placeholder="Your Name" 
                           class="w-full px-4 py-3 bg-white/10 backdrop-blur-md text-white rounded-xl border border-white/20 placeholder-gray-400">
                    <input type="tel" id="user-phone" placeholder="Phone Number" 
                           class="w-full px-4 py-3 bg-white/10 backdrop-blur-md text-white rounded-xl border border-white/20 placeholder-gray-400">
                    <input type="email" id="user-email" placeholder="Email Address" 
                           class="w-full px-4 py-3 bg-white/10 backdrop-blur-md text-white rounded-xl border border-white/20 placeholder-gray-400">
                    
                    <div class="flex items-start space-x-2 mt-4">
                        <input type="checkbox" id="privacy-consent" class="mt-1">
                        <label for="privacy-consent" class="text-xs text-gray-300">
                            I agree to receive golf tips and updates from Wright Now Solutions
                        </label>
                    </div>
                </div>
                
                <button id="continue-btn" class="w-full mt-6 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                    Start Your Session
                </button>
            </div>
        </div>

        <!-- Game Setup Screen -->
        <div id="game-setup-screen" class="screen flex-1 flex flex-col">
            <div class="flex items-center p-4 border-b border-white/10">
                <button id="back-btn" class="text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h2 class="flex-1 text-center text-xl font-semibold text-white">Course Setup</h2>
                <div class="w-6"></div>
            </div>
            
            <div class="flex-1 p-6 space-y-4 overflow-y-auto">
                <div>
                    <label class="text-white text-sm mb-2 block">Select Course</label>
                    <select id="course-select" class="w-full px-4 py-3 bg-white/10 backdrop-blur-md text-white rounded-xl border border-white/20" style="color: white;">
                        <option value="" style="color: #374151; background-color: white;">Choose a course...</option>
                        <option value="Chateau" style="color: #374151; background-color: white;">Chateau Course</option>
                        <option value="Woodlands" style="color: #374151; background-color: white;">Woodlands Course</option>
                    </select>
                </div>
                
                <div>
                    <label class="text-white text-sm mb-2 block">Hole Number</label>
                    <select id="hole-select" class="w-full px-4 py-3 bg-white/10 backdrop-blur-md text-white rounded-xl border border-white/20" style="color: white;">
                        <option value="" style="color: #374151; background-color: white;">Select hole...</option>
                    </select>
                </div>
                
                <div>
                    <label class="text-white text-sm mb-2 block">Tee Selection</label>
                    <select id="tee-select" class="w-full px-4 py-3 bg-white/10 backdrop-blur-md text-white rounded-xl border border-white/20" style="color: white;" disabled>
                        <option value="" style="color: #374151; background-color: white;">Select tee...</option>
                        <option value="white" style="color: #374151; background-color: white;">White Tees (Shortest)</option>
                        <option value="green" style="color: #374151; background-color: white;">Green Tees (Medium)</option>
                        <option value="gold" style="color: #374151; background-color: white;">Gold Tees (Longest)</option>
                    </select>
                </div>
                
                <div>
                    <label class="text-white text-sm mb-2 block">Distance to Pin (yards)</label>
                    <div class="flex space-x-2">
                        <input type="number" id="distance-input" placeholder="e.g., 145" 
                               class="flex-1 px-4 py-3 bg-white/10 backdrop-blur-md text-white rounded-xl border border-white/20 placeholder-gray-400">
                        <button type="button" id="voice-distance-btn" class="px-3 py-3 bg-blue-500/20 text-blue-300 rounded-xl border border-blue-500/30 hover:bg-blue-500/30 transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="text-white text-sm mb-2 block">Club Selection</label>
                    <select id="club-select" class="w-full px-4 py-3 bg-white/10 backdrop-blur-md text-white rounded-xl border border-white/20" style="color: white;">
                        <option value="" style="color: #374151; background-color: white;">Select club...</option>
                        <option value="Driver" style="color: #374151; background-color: white;">Driver</option>
                        <option value="3-wood" style="color: #374151; background-color: white;">3-wood</option>
                        <option value="5-wood" style="color: #374151; background-color: white;">5-wood</option>
                        <option value="3-iron" style="color: #374151; background-color: white;">3-iron</option>
                        <option value="4-iron" style="color: #374151; background-color: white;">4-iron</option>
                        <option value="5-iron" style="color: #374151; background-color: white;">5-iron</option>
                        <option value="6-iron" style="color: #374151; background-color: white;">6-iron</option>
                        <option value="7-iron" style="color: #374151; background-color: white;">7-iron</option>
                        <option value="8-iron" style="color: #374151; background-color: white;">8-iron</option>
                        <option value="9-iron" style="color: #374151; background-color: white;">9-iron</option>
                        <option value="PW" style="color: #374151; background-color: white;">Pitching Wedge</option>
                        <option value="SW" style="color: #374151; background-color: white;">Sand Wedge</option>
                        <option value="LW" style="color: #374151; background-color: white;">Lob Wedge</option>
                        <option value="Putter" style="color: #374151; background-color: white;">Putter</option>
                    </select>
                </div>
            </div>
            
            <div class="p-6">
                <button id="start-analysis-btn" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                    Get AI Coaching
                </button>
            </div>
        </div>

        <!-- Analysis Screen -->
        <div id="analysis-screen" class="screen flex-1 flex flex-col">
            <div class="flex-1 flex flex-col items-center justify-center p-6">
                <div class="mb-8">
                    <div class="w-32 h-32 rounded-full overflow-hidden mx-auto mb-4 ring-4 ring-white/20">
                        <img src="Golf Coach.png" 
                             alt="AI Coach" class="w-full h-full object-cover">
                    </div>
                    <h3 class="text-white text-xl font-semibold text-center">Your AI Coach</h3>
                    <p class="text-gray-300 text-center mt-2">What would you like help with?</p>
                </div>
                
                <div class="w-full space-y-3">
                    <button id="shot-advice-btn" class="w-full px-6 py-4 bg-white/10 backdrop-blur-md text-white rounded-xl border border-white/20 hover:bg-white/20 transition-all">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üéØ</span>
                            <div class="text-left">
                                <div class="font-semibold">Shot Planning</div>
                                <div class="text-sm text-gray-300">Get advice for your next shot</div>
                            </div>
                        </div>
                    </button>
                    
                    <button id="swing-analysis-btn" class="w-full px-6 py-4 bg-white/10 backdrop-blur-md text-white rounded-xl border border-white/20 hover:bg-white/20 transition-all">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üèåÔ∏è</span>
                            <div class="text-left">
                                <div class="font-semibold">Swing Analysis</div>
                                <div class="text-sm text-gray-300">Get tips to improve your swing</div>
                            </div>
                        </div>
                    </button>
                </div>
                
                <button id="new-hole-btn" class="mt-6 text-gray-300 underline">
                    Change Hole/Club
                </button>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="screen flex-1 flex flex-col items-center justify-center">
            <div class="relative">
                <div class="w-32 h-32 rounded-full overflow-hidden ring-4 ring-white/20 pulse-animation">
                    <img src="Golf Coach.png" 
                         alt="AI Coach" class="w-full h-full object-cover">
                </div>
                <div id="speaking-indicator" class="absolute bottom-0 right-0 w-8 h-8 rounded-full speaking-indicator hidden"></div>
            </div>
            <p id="loading-text" class="text-white mt-6 text-lg">Analyzing your shot...</p>
            <div class="flex space-x-2 mt-4">
                <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen flex-1 flex flex-col">
            <div class="flex items-center p-4 border-b border-white/10">
                <h2 class="flex-1 text-center text-xl font-semibold text-white">AI Coach Advice</h2>
            </div>
            
            <div class="flex-1 p-6 overflow-y-auto">
                <div class="mb-6">
                    <div id="avatar-container" class="w-24 h-24 rounded-full overflow-hidden mx-auto mb-4 ring-4 ring-white/20">
                        <img id="avatar-placeholder" src="Golf Coach.png" 
                             alt="AI Coach" class="w-full h-full object-cover">
                        <video id="avatar-video" class="w-full h-full object-cover hidden" autoplay muted loop playsinline></video>
                    </div>
                    <div id="speaking-indicator-results" class="h-2 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full mx-auto w-24 mb-4 hidden speaking-indicator"></div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                    <h3 id="advice-title" class="text-white text-lg font-semibold mb-3">Your Personalized Advice</h3>
                    <p id="advice-text" class="text-gray-200 leading-relaxed"></p>
                    
                    <div class="mt-6 pt-6 border-t border-white/20">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-400 text-sm">Confidence Level</span>
                            <span id="confidence-level" class="text-green-400 font-semibold">High</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 text-sm">Based on</span>
                            <span id="analysis-basis" class="text-gray-300 text-sm">Course Data + AI Analysis</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 space-y-3">
                    <button id="speak-advice-btn" class="w-full px-6 py-3 bg-blue-500/20 backdrop-blur-md text-blue-300 rounded-xl border border-blue-500/30 hover:bg-blue-500/30 transition-all flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                        </svg>
                        Hear Advice
                    </button>
                    
                    <button id="ask-again-btn" class="w-full px-6 py-3 bg-white/10 backdrop-blur-md text-white rounded-xl border border-white/20 hover:bg-white/20 transition-all">
                        Ask Another Question
                    </button>
                    
                    <button id="new-session-btn" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all">
                        New Hole
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        const appState = {
            userName: '',
            userPhone: '',
            userEmail: '',
            course: '',
            hole: '',
            tee: '',
            distance: '',
            club: '',
            currentAdvice: ''
        };

        // Function to clean text for display and speech
        function cleanTextForSpeech(text) {
            if (!text) return '';
            
            const cleaned = text
                // Remove markdown bold formatting
                .replace(/\*\*(.*?)\*\*/g, '$1')
                // Remove markdown italic formatting  
                .replace(/\*(.*?)\*/g, '$1')
                // Remove markdown headers
                .replace(/#{1,6}\s+/g, '')
                // Remove extra asterisks
                .replace(/\*/g, '')
                // Clean up numbered lists (1. 2. etc.)
                .replace(/^\d+\.\s+/gm, '')
                // Remove double spaces
                .replace(/\s+/g, ' ')
                // Remove leading/trailing whitespace
                .trim();
                
            console.log('üßπ Text cleaned for speech:');
            console.log('Before:', text.substring(0, 150) + '...');
            console.log('After:', cleaned.substring(0, 150) + '...');
            
            return cleaned;
        }

        // Voice input utility
        let recognition = null;
        let currentInputField = null;

        const voiceInput = {
            init: () => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = 'en-US';

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        console.log('Voice input received:', transcript);
                        if (currentInputField) {
                            // For distance input, extract numbers
                            if (currentInputField.id === 'distance-input') {
                                const numbers = transcript.match(/\d+/);
                                currentInputField.value = numbers ? numbers[0] : transcript;
                            } else {
                                currentInputField.value = transcript;
                            }
                            currentInputField.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    };

                    recognition.onerror = (event) => {
                        console.error('Voice recognition error:', event.error);
                        if (currentInputField) {
                            currentInputField.placeholder = 'Voice input failed - try typing';
                        }
                    };

                    recognition.onend = () => {
                        currentInputField = null;
                    };
                }
            },

            start: (inputFieldId) => {
                if (!recognition) {
                    alert('Voice input not supported in this browser');
                    return false;
                }

                currentInputField = document.getElementById(inputFieldId);
                if (!currentInputField) return false;

                currentInputField.placeholder = 'Listening... speak now';
                currentInputField.focus();
                
                try {
                    recognition.start();
                    return true;
                } catch (error) {
                    console.error('Failed to start voice recognition:', error);
                    currentInputField.placeholder = 'Voice input failed - try typing';
                    return false;
                }
            },

            stop: () => {
                if (recognition) {
                    recognition.stop();
                    currentInputField = null;
                }
            }
        };

        // Text-to-speech utility
        const textToSpeech = {
            currentAudio: null,
            
            // Try Google TTS first, fallback to browser TTS
            speak: async (text, onStart, onEnd) => {
                console.log('üé≠ Starting TTS for text:', text.substring(0, 50) + '...');
                
                try {
                    // Try Google TTS first
                    console.log('üîä Attempting Google Cloud TTS...');
                    const success = await textToSpeech.tryGoogleTTS(text, onStart, onEnd);
                    if (success) {
                        console.log('‚úÖ Google TTS successful');
                        return true;
                    }
                } catch (error) {
                    console.log('‚ùå Google TTS failed:', error.message);
                }
                
                // Fallback to enhanced browser TTS
                console.log('üîÑ Falling back to browser TTS...');
                return textToSpeech.useBrowserTTS(text, onStart, onEnd);
            },
            
            // Google Cloud TTS implementation
            tryGoogleTTS: async (text, onStart, onEnd) => {
                try {
                    const response = await fetch('/api/text-to-speech', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            text: text,
                            voice: 'en-US-Neural2-F', // High-quality female voice
                            speed: 1.0,
                            pitch: 0.0
                        })
                    });
                    
                    const data = await response.json();
                    console.log('Google TTS API response:', data);
                    
                    if (data.fallback) {
                        console.log('Google TTS indicated fallback:', data.message);
                        return false;
                    }
                    
                    if (data.success && data.audioContent) {
                        // Create audio from base64 data
                        const audioBlob = textToSpeech.base64ToBlob(data.audioContent, 'audio/mp3');
                        const audioUrl = URL.createObjectURL(audioBlob);
                        
                        // Create and play audio element
                        textToSpeech.currentAudio = new Audio(audioUrl);
                        
                        textToSpeech.currentAudio.onplay = () => {
                            console.log('üéµ Google TTS audio started');
                            if (onStart) onStart();
                        };
                        
                        textToSpeech.currentAudio.onended = () => {
                            console.log('üéµ Google TTS audio ended');
                            URL.revokeObjectURL(audioUrl); // Clean up
                            if (onEnd) onEnd();
                        };
                        
                        textToSpeech.currentAudio.onerror = (error) => {
                            console.error('Audio playback error:', error);
                            URL.revokeObjectURL(audioUrl);
                            if (onEnd) onEnd();
                        };
                        
                        await textToSpeech.currentAudio.play();
                        console.log(`‚úÖ Playing Google TTS with voice: ${data.voice}`);
                        return true;
                    }
                    
                    return false;
                } catch (error) {
                    console.error('Google TTS error:', error);
                    return false;
                }
            },
            
            // Enhanced browser TTS fallback (existing implementation)
            useBrowserTTS: (text, onStart, onEnd) => {
                if ('speechSynthesis' in window) {
                    // Cancel any previous speech
                    window.speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.95;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    // Select the best natural female voice
                    const voices = window.speechSynthesis.getVoices();
                    console.log('Available browser voices:', voices.map(v => `${v.name} (${v.lang})`));
                    
                    // Priority order for natural female voices
                    const femaleVoiceNames = [
                        'Microsoft Zira - English (United States)',
                        'Microsoft Hazel - English (Great Britain)', 
                        'Google US English Female',
                        'Samantha',
                        'Victoria',
                        'Serena',
                        'Allison',
                        'Ava',
                        'Susan',
                        'Karen'
                    ];
                    
                    // Find the best available female voice
                    let selectedVoice = null;
                    
                    // First try exact name matches
                    for (const voiceName of femaleVoiceNames) {
                        selectedVoice = voices.find(voice => voice.name === voiceName);
                        if (selectedVoice) break;
                    }
                    
                    // If no exact match, look for female voices by pattern
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => 
                            voice.name.toLowerCase().includes('female') ||
                            voice.name.toLowerCase().includes('woman') ||
                            (voice.name.includes('Microsoft') && 
                             (voice.name.includes('Zira') || voice.name.includes('Hazel'))) ||
                            (voice.lang.startsWith('en') && 
                             (voice.name.includes('Google') && voice.name.includes('Female')))
                        );
                    }
                    
                    // Fallback to any high-quality English voice
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.includes('Microsoft') || voice.name.includes('Google'))
                        );
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                        console.log(`Selected browser voice: ${selectedVoice.name} (${selectedVoice.lang})`);
                    } else {
                        console.log('Using default browser voice');
                    }
                    
                    // Optimize voice settings for natural sound
                    utterance.pitch = 1.1;    // Slightly higher pitch for female voice
                    utterance.rate = 0.9;     // Slightly slower for clarity
                    utterance.volume = 0.8;   // Comfortable volume
                    
                    utterance.onstart = onStart;
                    utterance.onend = onEnd;
                    
                    window.speechSynthesis.speak(utterance);
                    return true;
                }
                return false;
            },
            
            // Utility function to convert base64 to blob
            base64ToBlob: (base64, mimeType) => {
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: mimeType });
            },
            
            // Stop current speech (works for both Google and browser TTS)
            stop: () => {
                // Stop Google TTS audio if playing
                if (textToSpeech.currentAudio) {
                    textToSpeech.currentAudio.pause();
                    textToSpeech.currentAudio.currentTime = 0;
                    textToSpeech.currentAudio = null;
                }
                
                // Stop browser TTS
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                }
            }
        };

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Hole options based on course
        const courseHoles = {
            'Chateau': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18'],
            'Woodlands': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18']
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize voice capabilities
            if ('speechSynthesis' in window) {
                // Load voices and wait for them to be available
                const loadVoices = () => {
                    const voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        console.log('üé≠ Voices loaded:', voices.length, 'available');
                        // List all available voices for debugging
                        voices.forEach((voice, index) => {
                            console.log(`${index + 1}. ${voice.name} (${voice.lang}) - Local: ${voice.localService}`);
                        });
                    }
                };
                
                // Load voices immediately
                loadVoices();
                
                // Some browsers need this event
                window.speechSynthesis.onvoiceschanged = loadVoices;
                
                // Trigger voice loading
                window.speechSynthesis.getVoices();
            }
            voiceInput.init();

            // Welcome screen with debug logging
            document.getElementById('continue-btn').addEventListener('click', () => {
                console.log('üîò Button clicked - Start Your Session');
                
                const name = document.getElementById('user-name').value.trim();
                const phone = document.getElementById('user-phone').value.trim();
                const email = document.getElementById('user-email').value.trim();
                const consent = document.getElementById('privacy-consent').checked;

                console.log('üìã Form data:', { name, phone, email, consent });

                if (!name || !phone || !email) {
                    console.log('‚ùå Validation failed: Missing required fields');
                    alert('Please fill in all fields');
                    return;
                }

                if (!consent) {
                    console.log('‚ùå Validation failed: Consent not checked');
                    alert('Please agree to receive updates');
                    return;
                }

                console.log('‚úÖ Form validation passed');

                appState.userName = name;
                appState.userPhone = phone;
                appState.userEmail = email;

                console.log('üíæ Saving user data to API...');

                // Save user data
                fetch('/api/save-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, phone, email })
                })
                .then(response => {
                    console.log('üì° API Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üì° API Response data:', data);
                })
                .catch(error => {
                    console.error('‚ùå API Error:', error);
                });

                console.log('üñ•Ô∏è Transitioning to game setup screen...');
                showScreen('game-setup-screen');
            });

            // Course selection
            document.getElementById('course-select').addEventListener('change', async (e) => {
                const course = e.target.value;
                appState.course = course;

                const holeSelect = document.getElementById('hole-select');
                holeSelect.innerHTML = '<option value="" style="color: #374151; background-color: white;">Select hole...</option>';

                if (course && courseHoles[course]) {
                    courseHoles[course].forEach(hole => {
                        const option = document.createElement('option');
                        option.value = hole;
                        option.textContent = `Hole ${hole}`;
                        option.style.color = '#374151';
                        option.style.backgroundColor = 'white';
                        holeSelect.appendChild(option);
                    });
                }
            });

            // Hole selection - enable tee selection and default to white
            document.getElementById('hole-select').addEventListener('change', async (e) => {
                const hole = e.target.value;
                appState.hole = hole;
                
                const teeSelect = document.getElementById('tee-select');
                
                if (hole) {
                    // Enable tee selection and default to white
                    teeSelect.disabled = false;
                    teeSelect.value = 'white';
                    appState.tee = 'white';
                    
                    // Auto-populate distance with white tee distance
                    if (appState.course) {
                        await updateDistanceFromCourseData();
                    }
                } else {
                    // Disable tee selection and clear fields
                    teeSelect.disabled = true;
                    teeSelect.value = '';
                    appState.tee = '';
                    document.getElementById('distance-input').value = '';
                    appState.distance = '';
                }
            });

            // Function to update distance from course data
            async function updateDistanceFromCourseData() {
                if (!appState.course || !appState.hole || !appState.tee) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/course-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            course: appState.course, 
                            hole: appState.hole,
                            tee: appState.tee
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.distance) {
                            document.getElementById('distance-input').value = data.distance;
                            appState.distance = data.distance.toString();
                        }
                    }
                } catch (error) {
                    console.error('Error fetching course data:', error);
                }
            }

            // Tee selection - update distance when tee changes
            document.getElementById('tee-select').addEventListener('change', async (e) => {
                const tee = e.target.value;
                appState.tee = tee;
                
                if (appState.course && appState.hole && tee) {
                    await updateDistanceFromCourseData();
                }
            });

            // Start analysis
            document.getElementById('start-analysis-btn').addEventListener('click', () => {
                const distance = document.getElementById('distance-input').value;
                const club = document.getElementById('club-select').value;

                if (!appState.course || !appState.hole || !appState.tee || !distance || !club) {
                    alert('Please fill in all fields including tee selection');
                    return;
                }

                appState.distance = distance;
                appState.club = club;

                showScreen('analysis-screen');
            });

            // Shot advice
            document.getElementById('shot-advice-btn').addEventListener('click', async () => {
                showScreen('loading-screen');
                document.getElementById('loading-text').textContent = 'Analyzing your shot...';

                try {
                    const response = await fetch('/api/caddie-advice', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(appState)
                    });

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.message || data.error);
                    }

                    // Clean the advice text before storing and displaying
                    const cleanedAdvice = cleanTextForSpeech(data.advice);
                    appState.currentAdvice = cleanedAdvice;
                    document.getElementById('advice-title').textContent = `Shot Advice for Hole ${appState.hole}`;
                    document.getElementById('advice-text').textContent = cleanedAdvice;
                    document.getElementById('analysis-basis').textContent = `Hole ${appState.hole}, ${appState.distance} yards`;

                    showScreen('results-screen');

                    // Auto-speak the advice
                    setTimeout(() => {
                        document.getElementById('speak-advice-btn').click();
                    }, 500);

                } catch (error) {
                    console.error('Error:', error);
                    alert(`Sorry, there was an error: ${error.message}`);
                    showScreen('analysis-screen');
                }
            });

            // Swing analysis
            document.getElementById('swing-analysis-btn').addEventListener('click', async () => {
                showScreen('loading-screen');
                document.getElementById('loading-text').textContent = 'Analyzing your swing...';

                try {
                    const response = await fetch('/api/swing-analysis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(appState)
                    });

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.message || data.error);
                    }

                    // Clean the feedback text before storing and displaying
                    const cleanedFeedback = cleanTextForSpeech(data.feedback);
                    appState.currentAdvice = cleanedFeedback;
                    document.getElementById('advice-title').textContent = 'Swing Analysis';
                    document.getElementById('advice-text').textContent = cleanedFeedback;
                    document.getElementById('analysis-basis').textContent = `${appState.club} technique`;

                    showScreen('results-screen');

                    // Auto-speak the advice
                    setTimeout(() => {
                        document.getElementById('speak-advice-btn').click();
                    }, 500);

                } catch (error) {
                    console.error('Error:', error);
                    alert(`Sorry, there was an error: ${error.message}`);
                    showScreen('analysis-screen');
                }
            });

            // Speak advice
            document.getElementById('speak-advice-btn').addEventListener('click', () => {
                const button = document.getElementById('speak-advice-btn');
                const indicator = document.getElementById('speaking-indicator-results');
                
                if (button.textContent.includes('Stop')) {
                    textToSpeech.stop();
                    button.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>Hear Advice';
                    button.disabled = false;
                    indicator.classList.add('hidden');
                } else if (!button.disabled) {
                    // Immediately disable button and show processing state
                    button.disabled = true;
                    button.innerHTML = '<svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Processing Audio...';
                    
                    textToSpeech.speak(
                        appState.currentAdvice,
                        () => {
                            // Audio started playing
                            button.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>Stop Speaking';
                            button.disabled = false;
                            indicator.classList.remove('hidden');
                        },
                        () => {
                            // Audio finished or stopped
                            button.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>Hear Advice';
                            button.disabled = false;
                            indicator.classList.add('hidden');
                        }
                    );
                }
            });

            // Navigation buttons
            document.getElementById('ask-again-btn').addEventListener('click', () => {
                textToSpeech.stop();
                showScreen('analysis-screen');
            });

            document.getElementById('new-session-btn').addEventListener('click', () => {
                textToSpeech.stop();
                showScreen('game-setup-screen');
            });

            document.getElementById('new-hole-btn').addEventListener('click', () => {
                showScreen('game-setup-screen');
            });

            document.getElementById('back-btn').addEventListener('click', () => {
                showScreen('welcome-screen');
            });

            // Voice input for distance
            document.getElementById('voice-distance-btn').addEventListener('click', () => {
                voiceInput.start('distance-input');
            });
        });
    </script>
</body>
</html>